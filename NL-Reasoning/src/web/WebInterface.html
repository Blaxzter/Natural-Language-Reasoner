<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Natural Language Prover</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
            integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.2"></script>
    <script src="//d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
    <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <style>
        @import url("//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css");
        html {
            position: absolute;
            padding: 50px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 800px;
            min-width: 800px;
        }

        .expression_input > span {
            display: inline-block;
            width: 100px;
        }

        .expression_input > input {
            display: inline-block;
            width: 500px;
            transform: translateY(2px);
        }

        #graph > svg {
            width: 100%;
        }

        .heading {
            font-family: 'Dancing Script', cursive;
            font-size: 6.5rem;
            text-align: center;
            margin-bottom: 3rem;
        }

        .applied_rules {
            margin-top: 3rem;
        }

    </style>
</head>
<body>
<div>
    <header>
        <h1 class="heading">Natural Language Reasoner</h1>
    </header>
    <div id="app">
        <fieldset name="form" class="list-group">
            <label v-for="(item, index) in expressions" class="expression_input">
                <span>{{index + 1}}. input:</span>
                <input type="text" v-model:value="item.value" placeholder="Next Expression" class="form-control"/>
                <button v-on:click="remove_field(index)" type="button" class="btn btn-danger">-</button>
                <button v-if="index == expressions.length-1" v-on:click="add_field" type="button"
                        class="btn btn-success">+
                </button>
                <br>
            </label>
            <label class="expression_input" class="list-group-item">
                <span>To be shown:</span>
                <input type="text" v-bind:value="to_be_shown" class="form-control"/>
                <br>
            </label>
            <button v-on:click="send_request" type="button" class="btn btn-primary" style="margin-top: 8px;">Solve</button>
        </fieldset>
        <div class="card applied_rules" v-if="applied_rules.length != 0">
            <div class="card-header" >
                <h3 class="mb-0 d-inline align-middle" >Applied Rules</h3>
              <button class="btn btn-default float-right align-middle" type="button" data-toggle="collapse" data-target="#accordion" aria-expanded="false" aria-controls="collapseExample" v-on:click="up = !up">
                <span class="glyphicon glyphicon-chevron-up" aria-hidden="true" v-if="up == false" ></span>
                <span class="glyphicon glyphicon-chevron-down" aria-hidden="true" v-if="up == true" ></span>
              </button>
            </div>
            <div id="accordion" class="collapse">
                <div class="card" v-for="(rule, index) in applied_rules">
                    <div class="card-header" id="headingOne">
                        <h5 class="mb-0">
                            <button class="btn btn-link align-middle" data-toggle="collapse"
                                    v-bind:data-target="'#collapse-' + index"
                                    aria-expanded="true" v-bind:aria-controls="'collapse-'+ index">
                                {{index}}. applied rule {{rule.rule_name}}
                            </button>
                        </h5>
                    </div>

                    <div v-bind:id="'collapse-' + index" class="collapse" aria-labelledby="headingOne"
                         data-parent="#accordion">
                        <div class="card-body">

                            <table class="table">
                                <thead>
                                <tr>
                                    <th scope="col">Referenced Line</th>
                                    <th scope="col" v-if="rule.created_expressions">Created Expressions</th>
                                    <th scope="col">Used Expression</th>
                                    <th scope="col" v-if="rule.matched_expression != 'None'">Matched Expression</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>{{rule.referenced_line}}</td>
                                    <td v-if="rule.created_expressions">
                                        <ul>
                                            <li v-for="expression_list in rule.created_expressions">
                                                {{expression_list}}
                                            </li>
                                        </ul>
                                    </td>
                                    <td>{{rule.c_expression}}</td>
                                    <td v-if="rule.matched_expression != 'None'">{{rule.matched_expression}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="color: red">{{error}}</div>

        <div id="graph" style="text-align: center; width: 100%;"></div>

    </div>
</div>

</body>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            expressions: [
                {value: 'John plays football or chess'},
                {value: 'When it is raining, John plays not football'},
                {value: 'It is raining'}
            ],
            to_be_shown: 'John plays not football',
            response: '',
            error: '',
            applied_rules: [],
            up: true
        },
        methods: {
            remove_field(index) {
                this.expressions.splice(index, 1);
            },
            add_field() {
                this.expressions.push(
                    {value: ''}
                )
            },
            send_request() {
                this.error = ''
                // GET /someUrl
                let data = {expressions: this.expressions, to_be_shown: this.to_be_shown};
                this.$http.post('/solve-request', data).then(response => {

                    // get body data
                    this.response = response.body;
                    this.applied_rules = response.body['applied_rules']

                    for (let applied_rule_idx in this.applied_rules) {
                        applied_rule = this.applied_rules[applied_rule_idx]
                        if (applied_rule.created_expressions) {
                            console.log(applied_rule.created_expressions.replaceAll("'", '"'))
                            applied_rule.created_expressions = JSON.parse(applied_rule.created_expressions.replaceAll("'", '"'))
                        }
                    }

                    this.display_tree(response.body['dot_graph'])
                }, response => {
                    // error callback
                    this.error = response
                });
            },
            display_tree(dot_graph) {
                d3.select("#graph").graphviz()
                    .renderDot(dot_graph);
            }
        },
    })
</script>
</html>